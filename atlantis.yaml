version: 3
projects:
- name: deploy-aws
  dir: .
  # workspace: atlantis-lab
  autoplan:
    enabled: true
  workflow: terraform-infracost

# - name: destroy-aws
#   dir: .
#   workspace: atlantis-lab
#   autoplan:
#     enabled: false
#   workflow: destroy

workflows:
   terraform-infracost:
     plan:
       steps:
         - env:
             name: INFRACOST_OUTPUT
             command: 'echo "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/$WORKSPACE-${REPO_REL_DIR//\//-}-infracost.json"'
         - init
         - plan
         - show # this writes the plan JSON to $SHOWFILE
         - run: |
             if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
               mkdir -p /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
             fi
 
             infracost breakdown --path=$SHOWFILE \
                                 --format=json \
                                 --log-level=info \
                                 --out-file=$INFRACOST_OUTPUT

  # destroy:
  #   plan:
  #     steps:
  #     - plan:
  #         extra_args: ["-destroy"]
  #   apply:
  #     steps:
  #     - apply
